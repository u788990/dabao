name: 编译Nuitka终极独立版
on:
  workflow_dispatch:
  push:
    branches: [ main ]
jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 60
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
      
      - name: 安装Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: 安装Nuitka
        run: python -m pip install --upgrade nuitka
      
      - name: 检查并准备源文件
        shell: pwsh
        run: |
          Write-Host "当前目录所有Python文件:"
          Get-ChildItem *.py
          
          # 查找源文件(支持中文名或英文名)
          if (Test-Path "别快EXE打包工具 v4.2.py") {
            Copy-Item "别快EXE打包工具 v4.2.py" "GamePackager.py"
            Write-Host "✅ 已复制中文源文件为: GamePackager.py"
          } elseif (Test-Path "GamePackager_v4.2.py") {
            Copy-Item "GamePackager_v4.2.py" "GamePackager.py"
            Write-Host "✅ 已复制英文源文件为: GamePackager.py"
          } elseif (Test-Path "GamePackager_v4.2.py.py") {
            Copy-Item "GamePackager_v4.2.py.py" "GamePackager.py"
            Write-Host "✅ 已复制源文件为: GamePackager.py"
          } else {
            Write-Host "❌ 未找到源代码文件!"
            exit 1
          }
      
      - name: 设置UTF-8编码环境
        shell: pwsh
        run: |
          echo "PYTHONIOENCODING=utf-8" >> $env:GITHUB_ENV
          echo "PYTHONUTF8=1" >> $env:GITHUB_ENV
      
      - name: Nuitka 编译（终极版）
        shell: pwsh
        run: |
          Write-Host "开始编译你的终极打包神器..."
          python -m nuitka `
            --onefile `
            --windows-console-mode=disable `
            --enable-plugin=tk-inter `
            --output-dir=dist `
            --output-filename="BieKuai_Packager_v4.2.exe" `
            --show-progress `
            --windows-product-name="BieKuai EXE Packager" `
            --windows-company-name="BieKuai Studio" `
            --windows-file-version=4.2.0.0 `
            --windows-product-version=4.2.0.0 `
            --windows-file-description="EXE Package Tool" `
            "GamePackager.py"
          
          if ($LASTEXITCODE -eq 0) {
            Write-Host "✅ 编译成功完成!"
          } else {
            Write-Host "❌ 编译失败!"
            exit 1
          }
      
      - name: 重命名输出文件
        shell: pwsh
        run: |
          if (Test-Path "dist/BieKuai_Packager_v4.2.exe") {
            Rename-Item "dist/BieKuai_Packager_v4.2.exe" "别快打包神器-v4.2.exe"
            Write-Host "✅ 已重命名输出文件"
          }
      
      - name: 上传EXE
        uses: actions/upload-artifact@v4
        with:
          name: 别快打包神器-v4.2-Nuitka版
          path: dist/*.exe
