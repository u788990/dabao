name: 编译Nuitka(低误报版)
on:
  workflow_dispatch:
  push:
    branches: [ main ]
jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 60
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
      
      - name: 安装Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: 安装Nuitka
        run: python -m pip install --upgrade nuitka
      
      - name: Nuitka 编译(低误报配置)
        shell: pwsh
        run: |
          Write-Host "开始编译..."
          python -m nuitka `
            --onefile `
            --windows-console-mode=disable `
            --enable-plugin=tk-inter `
            --output-dir=dist `
            --output-filename="GamePackager.exe" `
            --show-progress `
            --assume-yes-for-downloads `
            --mingw64 `
            --lto=no `
            --windows-file-version=4.2.0.0 `
            --windows-product-version=4.2.0.0 `
            --windows-company-name="BieKuai Studio" `
            --windows-product-name="Game Packager" `
            --windows-file-description="Game Packaging Tool for Windows" `
            "GamePackager.py"
          
          if ($LASTEXITCODE -eq 0) {
            Write-Host "✅ 编译成功!"
          } else {
            exit 1
          }
      
      - name: 创建安全说明
        shell: pwsh
        run: |
          @"
          ⚠️ 杀毒软件可能误报解决方案：
          
          1. 添加到 Windows Defender 白名单：
             设置 → Windows安全中心 → 病毒和威胁防护 → 排除项 → 添加文件
          
          2. 验证安全性：
             上传到 virustotal.com 扫描查看详细报告
          
          3. 本程序开源，代码透明可审查
          
          "@ | Out-File -FilePath "dist\安全说明.txt" -Encoding UTF8
      
      - name: 打包发布
        shell: pwsh
        run: |
          Compress-Archive -Path "dist\*" -DestinationPath "GamePackager-v4.2.zip"
      
      - name: 上传构建产物
        uses: actions/upload-artifact@v4
        with:
          name: GamePackager-v4.2
          path: GamePackager-v4.2.zip
